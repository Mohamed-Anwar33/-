<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>جدول المهام - الجدول الأول والثاني</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        font-family: "Tajawal", sans-serif;
        background-color: #f0f4f8;
        direction: rtl;
        margin: 0;
        padding: 0;
      }
      .container {
        padding: 15px;
        max-width: 1200px;
        margin: 0 auto;
        text-align: right;
      }
      h2,
      h3,
      h4 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 8px;
      }
      .small-text {
        font-size: 12px;
        text-align: right;
      }
      .table-section {
        margin-bottom: 10px;
      }
      .table {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
      }
      .table-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }
      .table th,
      .table td {
        text-align: center;
        vertical-align: middle;
        padding: 8px;
      }
      .table td {
        font-size: 14px;
        font-weight: bold;
      }
      /* تعديل عرض الأعمدة */
      .table th:nth-child(1),
      .table td:nth-child(1) {
        /* التسلسل */
        width: 5%;
      }
      .table th:nth-child(2),
      .table td:nth-child(2) {
        /* اليوم والتاريخ */
        width: 15%;
      }
      .table th:nth-child(3),
      .table td:nth-child(3) {
        /* المباشرة بالموقع */
        width: 10%;
      }
      .table th:nth-child(4),
      .table td:nth-child(4) {
        /* نوع المهمة */
        width: 25%;
      }
      .table th:nth-child(5),
      .table td:nth-child(5) {
        /* الموقع */
        width: 15%;
      }
      .table th:nth-child(6),
      .table td:nth-child(6) {
        /* المطلوب */
        width: 25%;
      }
      .table th:nth-child(7),
      .table td:nth-child(7) {
        /* تعديل */
        width: 5%;
      }
      /* تقليص عرض عناصر select في عمود اليوم والتاريخ */
      .hijri-select {
        width: 50px !important;
        font-size: 10px;
        padding: 2px;
      }
      .action-buttons {
        display: flex;
        justify-content: center;
        gap: 5px;
        flex-wrap: wrap;
      }
      .edit-btn,
      .complete-btn,
      .delete-btn,
      .important-btn,
      .remove-color-btn {
        margin: 2px;
        padding: 4px 8px;
        font-size: 12px;
        white-space: nowrap;
      }
      .important-task-dark-red {
        background-color: #ff9999 !important;
      }
      .important-task-dark-purple {
        background-color: #e6ccff !important;
      }
      .important-task-dark-green {
        background-color: #99cc99 !important;
      }
      .important-task-dark-blue {
        background-color: #99ccff !important;
      }
      .important-task-dark-brown {
        background-color: #d9b38c !important;
      }
      .important-task-deep-red {
        background-color: #e57373 !important;
      }
      .important-task-deep-blue {
        background-color: #64b5f6 !important;
      }
      .important-task-deep-green {
        background-color: #81c784 !important;
      }
      .important-task-deep-orange {
        background-color: #ffb74d !important;
      }
      .important-task-deep-purple {
        background-color: #ba68c8 !important;
      }
      .color-picker {
        margin-top: 5px;
      }
      .color-select {
        width: 120px;
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #ced4da;
        font-size: 12px;
        transition: all 0.3s ease;
      }
      .color-select:focus {
        outline: none;
        border-color: #2c3e50;
        box-shadow: 0 0 5px rgba(44, 62, 80, 0.3);
      }
      .color-select option {
        padding: 5px;
      }
      .notes {
        text-align: right;
      }
      .notes ul,
      .notes p {
        font-size: 11px;
      }
      .signature-section {
        text-align: left; /* تغيير المحاذاة إلى الجهة اليسرى (الشمال) */
        width: 100%;
      }
      .signature-section p {
        display: block;
        text-align: left;
        margin-left: 0;
        margin-right: auto;
      }
      .time-input,
      .hijri-select,
      .color-select {
        margin: 0 2px;
        display: inline-block;
      }
      .date-controls {
        display: flex;
        gap: 5px;
        justify-content: center;
      }
      /* إخفاء النص المخصص للطباعة في العرض العادي */
      .print-date {
        display: none;
      }
      @media print {
        .date-controls,
        .table-buttons,
        .edit-column,
        button,
        .action-buttons,
        .navigation-buttons,
        a.btn {
          display: none !important;
        }
        /* إجبار ظهور الألوان الخلفية */
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        /* إخفاء القوائم المنسدلة في أعمدة التاريخ */
        .hijri-select {
          display: none !important;
        }
        /* إظهار النص المخصص للطباعة */
        .print-date {
          display: inline !important;
        }
        /* التأكد من أن الألوان الخلفية للمهام المهمة تظهر */
        .important-task-dark-red {
          background-color: #ff9999 !important;
        }
        .important-task-dark-purple {
          background-color: #e6ccff !important;
        }
        .important-task-dark-green {
          background-color: #99cc99 !important;
        }
        .important-task-dark-blue {
          background-color: #99ccff !important;
        }
        .important-task-dark-brown {
          background-color: #d9b38c !important;
        }
        .important-task-deep-red {
          background-color: #e57373 !important;
        }
        .important-task-deep-blue {
          background-color: #64b5f6 !important;
        }
        .important-task-deep-green {
          background-color: #81c784 !important;
        }
        .important-task-deep-orange {
          background-color: #ffb74d !important;
        }
        .important-task-deep-purple {
          background-color: #ba68c8 !important;
        }
        /* التأكد من أن التوقيع يظهر في الجهة اليسرى عند الطباعة */
        .signature-section {
          text-align: left;
          width: 100%;
        }
        .signature-section p {
          text-align: left;
          margin-left: 0;
          margin-right: auto;
        }
      }
      @media (max-width: 430px) {
        .table {
          font-size: 9px;
          min-width: 600px;
        }
        .table-responsive {
          overflow-x: auto;
        }
        .edit-btn,
        .complete-btn,
        .delete-btn,
        .important-btn,
        .remove-color-btn {
          padding: 2px 4px;
          font-size: 9px;
          min-width: 50px;
        }
        .container {
          padding: 5px;
        }
        .action-buttons {
          flex-direction: column;
          gap: 2px;
          justify-content: center;
        }
        .hijri-select,
        .color-select {
          width: 40px !important;
          font-size: 8px;
        }
        .table th,
        .table td {
          padding: 3px;
        }
        .table td {
          white-space: normal;
          line-height: 1.2;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="text-center mt-3">
        <div class="small-text">
          <span class="editable" id="title1">السرية الأولى</span>
          <button
            class="btn btn-warning btn-sm edit-btn"
            onclick="editText('title1')"
          >
            تعديل
          </button>
        </div>
        <div class="small-text">
          <span class="editable" id="title2">فصيل (1)</span>
          <button
            class="btn btn-warning btn-sm edit-btn"
            onclick="editText('title2')"
          >
            تعديل
          </button>
        </div>
        <div class="small-text">
          <span class="editable" id="title3">مجموعة (7)</span>
          <button
            class="btn btn-warning btn-sm edit-btn"
            onclick="editText('title3')"
          >
            تعديل
          </button>
        </div>
        <h4 class="header fs-6 editable" id="title4">
          بيان بالمهام المكلفة بها قوة المهام والواجبات الخاصة ليوم
          <span id="selected-date"></span>
          <span id="print-selected-date" class="print-date"></span>
        </h4>
        <div class="date-controls mt-2">
          <select
            class="hijri-select"
            id="header-weekday"
            onchange="updateHeaderDate()"
          >
            <option value="السبت" selected>السبت</option>
            <option value="الأحد">الأحد</option>
            <option value="الإثنين">الإثنين</option>
            <option value="الثلاثاء">الثلاثاء</option>
            <option value="الأربعاء">الأربعاء</option>
            <option value="الخميس">الخميس</option>
            <option value="الجمعة">الجمعة</option>
          </select>
          <select
            class="hijri-select"
            id="header-day"
            onchange="updateHeaderDate()"
          ></select>
          <select
            class="hijri-select"
            id="header-month"
            onchange="updateHeaderDate()"
          ></select>
          <select
            class="hijri-select"
            id="header-year"
            onchange="updateHeaderDate()"
          ></select>
        </div>
      </div>

      <div class="table-responsive table-section">
        <table
          class="table table-bordered table-striped text-center align-middle"
          id="mainTable1"
        >
          <thead class="table-dark">
            <tr>
              <th>التسلسل</th>
              <th>اليوم والتاريخ</th>
              <th>المباشرة بالموقع</th>
              <th>نوع المهمة</th>
              <th>الموقع</th>
              <th>المطلوب</th>
              <th class="edit-column">تعديل</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="table-buttons mt-3">
          <button
            class="btn btn-success btn-sm"
            onclick="addNewRow('mainTable1')"
          >
            إضافة صف
          </button>
          <button
            class="btn btn-primary btn-sm print-btn"
            onclick="printTable('mainTable1')"
          >
            طباعة
          </button>
        </div>
      </div>

      <div class="table-responsive table-section">
        <table
          class="table table-bordered table-striped text-center align-middle"
          id="mainTable2"
        >
          <thead class="table-dark">
            <tr>
              <th>اليوم والتاريخ</th>
              <th>المباشرة بالموقع</th>
              <th>نوع المهمة</th>
              <th>الموقع</th>
              <th>المطلوب</th>
              <th class="edit-column">تعديل</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="table-buttons mt-3">
          <button
            class="btn btn-success btn-sm"
            onclick="addNewRow('mainTable2')"
          >
            إضافة صف
          </button>
          <button
            class="btn btn-primary btn-sm print-btn"
            onclick="printTable('mainTable2')"
          >
            طباعة
          </button>
        </div>
      </div>

      <div class="introduction mt-5" style="font-size: 8px">
        <p class="text-center" style="font-size: 8px">
          <span style="display: block">ص/ ضباط خفر</span>
          <span style="display: block">ص/ رقباء السرايا</span>
          <span style="display: block">ص/ العمليات</span>
        </p>
        <p class="text-end" style="font-size: 8px">
          السلام عليكم ورحمة الله وبركاته، تجدون أعلاه بيان بالمهام الأسبوعية
          المراد تغطيتها أمنياً من قبلكم، بالإضافة للمهام الطارئة، لذا عليكم
          متابعة تغطيتها بالوقت المحدد دون أي ملاحظات، مع التنبيه على العموم
          بارتداء السلاح والتجهيزات الميدانية اللازمة لكل مهمة كالخدمة والتنسيق
          معنا بما يستجد أول بأول،،، والسلام.
        </p>
      </div>

      <div class="notes mt-5" style="text-align: right">
        <h5 class="editable" id="notesTitle" style="font-size: 6px">
          ملاحظات هامة جدا يجب الاطلاع عليها والتقيد بها حرفياً أثناء الاستلام:
        </h5>
        <button
          class="btn btn-warning btn-sm edit-btn"
          onclick="editText('notesTitle')"
        >
          تعديل
        </button>
        <ul style="font-size: 8px">
          <li>حراسة البوابة الرسمية.</li>
          <li>مهام طارئة تصل بشكل مفاجئ يجب الاستعداد لها.</li>
          <li>
            التقيد بالتوجيهات والاوامر والعمل بها وتنفيذها بكل دقة أثناء
            تأديتها.
          </li>
          <li>
            إعداد التقارير اللازمة لكل مهمة وتسليمها بعد الانتهاء منها مباشرة.
          </li>
          <li>التسلح والتجهيز المناسب ويكون حسب نوع المهمة.</li>
          <li>
            عند وجود أي ملاحظة أثناء المهمة يجب إبلاغ الضابط المستلم عن طريق
            غرفة العمليات أو الاتصال المباشر بنا وأخذ التوجيهات بهذا الشأن.
          </li>
          <li>أخذ الحيطة والحذر والاحتياطات الأمنية اللازمة من قبل الجميع.</li>
          <li>
            يمنع الخروج أثناء الاستلام لأي سبب وتكون المسئولية كاملة على الضابط
            المستلم.
          </li>
          <li>
            أي مهمة رسمية خلال الاستلام على الضابط المستلم مباشرتها وعلى
            مسؤوليته شخصياً.
          </li>
          <li>
            على الرقيب المستلم التعقيب على جميع المواقع المذكورة أعلاه والتأكد
            على عدم وجود أي ملاحظات في جميع المواقع والرفع لنا عن أي شيء يستوجب
            الرفع في حينه.
          </li>
          <li>
            في حال طلب مندوب للمشاركة بأي لجنة من قبل الإدارات الحكومية
            بالمنطقة، يكلف العدد الكافي من الأفراد والدوريات من قبل الضابط
            المستلم وتحت مسؤوليته شخصياً، وإشعارنا عن المهمة في حينها.
          </li>
          <li>
            التقيد بالحضور بالوقت المحدد وعدم الانصراف حتى أخذ التوجيه من
            العمليات.
          </li>
          <li>عدم تشغيل السيفتي أثناء التوجه للموقع والمغادرة منه.</li>
        </ul>

        <!-- قسم التوقيع المعاد مع المحاذاة إلى الجهة اليسرى (الشمال) -->
        <div class="signature-section">
          <p
            id="signatureName"
            class="editable"
            style="
              font-size: 14px;
              font-family: 'Tajawal', sans-serif;
              line-height: 1.2;
              display: block;
              word-spacing: -1px;
              letter-spacing: -0.5px;
            "
          >
            <span>
              <div style="margin-left: 380px">عميد /</div>
              <div style="padding-right: 50px">
                <span>قائد قوة المهام والواجبات الخاصة</span>
                <span style="margin-right: 2px">فيصل بن خالد النفيسة</span>
              </div>
            </span>
          </p>
          <button
            class="btn btn-warning btn-sm edit-btn"
            onclick="editText('signatureName')"
          >
            تعديل
          </button>
        </div>
      </div>

      <div class="text-center mt-4 navigation-buttons">
        <a href="second.html" class="btn btn-secondary btn-sm">الجدول الثالث</a>
        <a href="pending_tasks.html" class="btn btn-warning btn-sm"
          >المهام المؤجلة</a
        >
        <a href="feauturetsaks.html" class="btn btn-warning btn-sm"
          >المهام المستقبلية</a
        >
        <a href="statistics.html" class="btn btn-secondary btn-sm">الإحصائية</a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let hijriYear = 1444;
      let hijriMonth = 8;
      let hijriDay = 5;
      let weekDay = "السبت";

      const hijriMonths = [
        "محرم",
        "صفر",
        "ربيع أول",
        "ربيع ثاني",
        "جمادى أول",
        "جمادى ثاني",
        "رجب",
        "شعبان",
        "رمضان",
        "شوال",
        "ذو القعدة",
        "ذو الحجة",
      ];
      const weekDays = [
        "السبت",
        "الأحد",
        "الإثنين",
        "الثلاثاء",
        "الأربعاء",
        "الخميس",
        "الجمعة",
      ];

      const importantColors = [
        "important-task-dark-red",
        "important-task-dark-purple",
        "important-task-dark-green",
        "important-task-dark-blue",
        "important-task-dark-brown",
        "important-task-deep-red",
        "important-task-deep-blue",
        "important-task-deep-green",
        "important-task-deep-orange",
        "important-task-deep-purple",
      ];

      function populateDateSelects() {
        const daySelects = document.querySelectorAll(
          "select[name='hijri-day']"
        );
        daySelects.forEach((select) => {
          select.innerHTML = Array.from({ length: 30 }, (_, i) => i + 1)
            .map(
              (day) =>
                `<option value="${day}" ${
                  day === hijriDay ? "selected" : ""
                }>${day}</option>`
            )
            .join("");
        });

        const monthSelects = document.querySelectorAll(
          "select[name='hijri-month']"
        );
        monthSelects.forEach((select) => {
          select.innerHTML = hijriMonths
            .map(
              (m, i) =>
                `<option value="${i + 1}" ${
                  i + 1 === hijriMonth ? "selected" : ""
                }>${m}</option>`
            )
            .join("");
        });

        const yearSelects = document.querySelectorAll(
          "select[name='hijri-year']"
        );
        yearSelects.forEach((select) => {
          select.innerHTML = Array.from({ length: 41 }, (_, i) => 1430 + i)
            .map(
              (year) =>
                `<option value="${year}" ${
                  year === hijriYear ? "selected" : ""
                }>${year}</option>`
            )
            .join("");
        });

        const weekDaySelects = document.querySelectorAll(
          "select[name='week-day']"
        );
        weekDaySelects.forEach((select) => {
          select.innerHTML = weekDays
            .map(
              (day) =>
                `<option value="${day}" ${
                  day === weekDay ? "selected" : ""
                }>${day}</option>`
            )
            .join("");
        });

        const headerDaySelect = document.getElementById("header-day");
        headerDaySelect.innerHTML = Array.from({ length: 30 }, (_, i) => i + 1)
          .map(
            (day) =>
              `<option value="${day}" ${
                day === hijriDay ? "selected" : ""
              }>${day}</option>`
          )
          .join("");

        const headerMonthSelect = document.getElementById("header-month");
        headerMonthSelect.innerHTML = hijriMonths
          .map(
            (m, i) =>
              `<option value="${i + 1}" ${
                i + 1 === hijriMonth ? "selected" : ""
              }>${m}</option>`
          )
          .join("");

        const headerYearSelect = document.getElementById("header-year");
        headerYearSelect.innerHTML = Array.from(
          { length: 41 },
          (_, i) => 1430 + i
        )
          .map(
            (year) =>
              `<option value="${year}" ${
                year === hijriYear ? "selected" : ""
              }>${year}</option>`
          )
          .join("");

        const headerWeekDaySelect = document.getElementById("header-weekday");
        headerWeekDaySelect.innerHTML = weekDays
          .map(
            (day) =>
              `<option value="${day}" ${
                day === weekDay ? "selected" : ""
              }>${day}</option>`
          )
          .join("");
      }

      function updateHeaderDate() {
        weekDay = document.getElementById("header-weekday").value;
        hijriDay = parseInt(document.getElementById("header-day").value);
        hijriMonth = parseInt(document.getElementById("header-month").value);
        hijriYear = parseInt(document.getElementById("header-year").value);
        const selectedDate = `${weekDay} ${hijriDay} ${
          hijriMonths[hijriMonth - 1]
        } ${hijriYear}`;
        const printDate = `اليوم: ${weekDay} ${hijriDay} ${
          hijriMonths[hijriMonth - 1]
        }، ${hijriYear} هـ`;
        document.getElementById("selected-date").innerText = selectedDate;
        document.getElementById("print-selected-date").innerText = printDate;
        updateAllTables();
        saveTableData("mainTable1");
        saveTableData("mainTable2");
        updatePendingTasks();
      }

      function sortTableByStartTime(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const rows = Array.from(table.getElementsByTagName("tr"));
        rows.sort((a, b) => {
          const timeA = a.cells[tableId === "mainTable1" ? 2 : 1].innerText;
          const timeB = b.cells[tableId === "mainTable1" ? 2 : 1].innerText;
          return timeA.localeCompare(timeB);
        });
        table.innerHTML = "";
        rows.forEach((row, index) => {
          if (tableId === "mainTable1") {
            row.cells[0].innerText = index + 1;
          }
          table.appendChild(row);
        });
      }

      function addNewRow(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const newRow = table.insertRow();
        const rowIndex = table.rows.length;
        const dateText = `${weekDay} ${hijriDay} ${
          hijriMonths[hijriMonth - 1]
        }، ${hijriYear} هـ`;
        newRow.innerHTML = `
          ${tableId === "mainTable1" ? `<td>${rowIndex}</td>` : ""}
          <td class="date-cell">
            <select class="hijri-select" name="week-day">
              ${weekDays
                .map(
                  (day) =>
                    `<option value="${day}" ${
                      day === weekDay ? "selected" : ""
                    }>${day}</option>`
                )
                .join("")}
            </select>
            <select class="hijri-select" name="hijri-day">
              ${Array.from({ length: 30 }, (_, i) => i + 1)
                .map(
                  (day) =>
                    `<option value="${day}" ${
                      day === hijriDay ? "selected" : ""
                    }>${day}</option>`
                )
                .join("")}
            </select>
            <select class="hijri-select" name="hijri-month">
              ${hijriMonths
                .map(
                  (m, i) =>
                    `<option value="${i + 1}" ${
                      i + 1 === hijriMonth ? "selected" : ""
                    }>${m}</option>`
                )
                .join("")}
            </select>
            <select class="hijri-select" name="hijri-year">
              ${Array.from({ length: 41 }, (_, i) => 1430 + i)
                .map(
                  (year) =>
                    `<option value="${year}" ${
                      year === hijriYear ? "selected" : ""
                    }>${year}</option>`
                )
                .join("")}
            </select>
            <span class="print-date">${dateText}</span>
          </td>
          <td contenteditable="true">06:00</td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td class="edit-column">
            <div class="action-buttons">
              <button class="btn btn-warning btn-sm edit-btn" onclick="editTable('${tableId}')">تعديل</button>
              <button class="btn btn-success btn-sm complete-btn" onclick="toggleComplete(this, '${tableId}')">اكتمال</button>
              <button class="btn btn-danger btn-sm delete-btn" onclick="deleteTask(this, '${tableId}')">حذف</button>
              <button class="btn btn-danger btn-sm important-btn" onclick="showColorPicker(this, '${tableId}')">تحديد اللون</button>
              <button class="btn btn-secondary btn-sm remove-color-btn" onclick="removeColor(this, '${tableId}')">إزالة اللون</button>
            </div>
          </td>
        `;
        saveTableData(tableId);
        sortTableByStartTime(tableId);
        updatePendingTasks();
      }

      function toggleComplete(button, tableId) {
        const row = button.closest("tr");
        const isCompleted = button.innerText === "إلغاء الاكتمال";

        if (isCompleted) {
          button.innerText = "اكتمال";
        } else {
          button.innerText = "إلغاء الاكتمال";
        }

        saveTableData(tableId);
        updatePendingTasks();
      }

      function showColorPicker(button, tableId) {
        const row = button.closest("tr");
        const actionButtons = row.querySelector(".action-buttons");
        const existingPicker = actionButtons.querySelector(".color-picker");

        if (existingPicker) {
          existingPicker.remove();
          return;
        }

        const colorNames = [
          "أحمر داكن",
          "أرجواني فاتح",
          "أخضر داكن",
          "أزرق داكن",
          "بني فاتح",
          "أحمر غامق",
          "أزرق غامق",
          "أخضر غامق",
          "برتقالي غامق",
          "بنفسجي غامق",
        ];

        const colorPicker = document.createElement("div");
        colorPicker.className = "color-picker";
        colorPicker.innerHTML = `
          <select class="color-select" onchange="applyColor(this, '${tableId}')">
            <option value="" disabled selected>اختر لونًا</option>
            ${importantColors
              .map(
                (color, index) =>
                  `<option value="${color}">${colorNames[index]}</option>`
              )
              .join("")}
          </select>
        `;
        actionButtons.appendChild(colorPicker);
      }

      function applyColor(select, tableId) {
        const row = select.closest("tr");
        const color = select.value;
        const button = row.querySelector(".important-btn");
        const startIndex = tableId === "mainTable1" ? 1 : 0;
        const dataCells = Array.from(row.querySelectorAll("td")).slice(
          startIndex,
          -1
        );

        if (color) {
          dataCells.forEach((cell) => {
            importantColors.forEach((c) => cell.classList.remove(c));
            cell.classList.add(color);
          });
          button.innerText = "إلغاء الأهمية";
        }

        select.parentElement.remove();
        saveTableData(tableId);
        updatePendingTasks();
      }

      function removeColor(button, tableId) {
        const row = button.closest("tr");
        const startIndex = tableId === "mainTable1" ? 1 : 0;
        const dataCells = Array.from(row.querySelectorAll("td")).slice(
          startIndex,
          -1
        );
        const importantButton = row.querySelector(".important-btn");

        dataCells.forEach((cell) => {
          importantColors.forEach((c) => cell.classList.remove(c));
        });
        importantButton.innerText = "تحديد اللون";

        saveTableData(tableId);
        updatePendingTasks();
      }

      function editTable(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const rows = table.getElementsByTagName("tr");
        for (let row of rows) {
          const cells = row.getElementsByTagName("td");
          const offset = tableId === "mainTable1" ? 1 : 0;
          cells[1 + offset].contentEditable = "true";
          cells[2 + offset].contentEditable = "true";
          cells[3 + offset].contentEditable = "true";
          cells[4 + offset].contentEditable = "true";
          const editButton = row.querySelector(".edit-btn");
          editButton.innerText = "حفظ";
          editButton.className = "btn btn-success btn-sm edit-btn";
          editButton.onclick = function () {
            saveTable(tableId);
          };
        }
      }

      function saveTable(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const rows = table.getElementsByTagName("tr");
        for (let row of rows) {
          const cells = row.getElementsByTagName("td");
          const offset = tableId === "mainTable1" ? 1 : 0;
          cells[1 + offset].contentEditable = "false";
          cells[2 + offset].contentEditable = "false";
          cells[3 + offset].contentEditable = "false";
          cells[4 + offset].contentEditable = "false";
          const editButton = row.querySelector(".edit-btn");
          editButton.innerText = "تعديل";
          editButton.className = "btn btn-warning btn-sm edit-btn";
          editButton.onclick = function () {
            editTable(tableId);
          };
        }
        saveTableData(tableId);
        sortTableByStartTime(tableId);
        updatePendingTasks();
      }

      function deleteTask(button, tableId) {
        const row = button.closest("tr");
        row.remove();
        saveTableData(tableId);
        sortTableByStartTime(tableId);
        updatePendingTasks();
      }

      function saveTableData(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const rows = table.getElementsByTagName("tr");
        const data = [];
        for (let row of rows) {
          const cells = row.getElementsByTagName("td");
          const offset = tableId === "mainTable1" ? 1 : 0;
          const weekDay = cells[0 + offset].querySelector(
            "select[name='week-day']"
          ).value;
          const day = cells[0 + offset].querySelector(
            "select[name='hijri-day']"
          ).value;
          const month = cells[0 + offset].querySelector(
            "select[name='hijri-month']"
          ).value;
          const year = cells[0 + offset].querySelector(
            "select[name='hijri-year']"
          ).value;
          const isCompleted =
            cells[0 + offset].parentElement.querySelector(".complete-btn")
              .innerText === "إلغاء الاكتمال";
          const isImportant = importantColors.some((color) =>
            cells[1 + offset].classList.contains(color)
          );
          const importantColor =
            importantColors.find((color) =>
              cells[1 + offset].classList.contains(color)
            ) || "";
          const dateText = `${weekDay} ${day} ${
            hijriMonths[month - 1]
          }، ${year} هـ`;
          cells[0 + offset].querySelector(".print-date").innerText = dateText;
          data.push([
            `${weekDay} ${day} ${hijriMonths[month - 1]} ${year}`,
            cells[1 + offset].innerText,
            cells[2 + offset].innerText,
            cells[3 + offset].innerText,
            cells[4 + offset].innerText,
            isCompleted,
            isImportant,
            importantColor,
          ]);
        }
        localStorage.setItem(tableId + "_tasks", JSON.stringify(data));
      }

      function loadTableData(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const savedData = localStorage.getItem(tableId + "_tasks");
        if (savedData) {
          table.innerHTML = "";
          JSON.parse(savedData).forEach((rowData, index) => {
            const [weekDay, day, monthName, year] = rowData[0].split(" ");
            const month = hijriMonths.indexOf(monthName) + 1;
            const isCompleted = rowData[5];
            const isImportant = rowData[6] || false;
            const importantColor = rowData[7] || "";
            const dateText = `${weekDay} ${day} ${
              hijriMonths[month - 1]
            }، ${year} هـ`;
            const row = table.insertRow();
            row.innerHTML = `
              ${tableId === "mainTable1" ? `<td>${index + 1}</td>` : ""}
              <td class="date-cell">
                <select class="hijri-select" name="week-day">
                  ${weekDays
                    .map(
                      (d) =>
                        `<option value="${d}" ${
                          d === weekDay ? "selected" : ""
                        }>${d}</option>`
                    )
                    .join("")}
                </select>
                <select class="hijri-select" name="hijri-day">
                  ${Array.from({ length: 30 }, (_, i) => i + 1)
                    .map(
                      (d) =>
                        `<option value="${d}" ${
                          d === parseInt(day) ? "selected" : ""
                        }>${d}</option>`
                    )
                    .join("")}
                </select>
                <select class="hijri-select" name="hijri-month">
                  ${hijriMonths
                    .map(
                      (m, i) =>
                        `<option value="${i + 1}" ${
                          i + 1 === parseInt(month) ? "selected" : ""
                        }>${m}</option>`
                    )
                    .join("")}
                </select>
                <select class="hijri-select" name="hijri-year">
                  ${Array.from({ length: 41 }, (_, i) => 1430 + i)
                    .map(
                      (y) =>
                        `<option value="${y}" ${
                          y === parseInt(year) ? "selected" : ""
                        }>${y}</option>`
                    )
                    .join("")}
                </select>
                <span class="print-date">${dateText}</span>
              </td>
              <td contenteditable="false">${rowData[1]}</td>
              <td contenteditable="false">${rowData[2]}</td>
              <td contenteditable="false">${rowData[3]}</td>
              <td contenteditable="false">${rowData[4]}</td>
              <td class="edit-column">
                <div class="action-buttons">
                  <button class="btn btn-warning btn-sm edit-btn" onclick="editTable('${tableId}')">تعديل</button>
                  <button class="btn btn-success btn-sm complete-btn" onclick="toggleComplete(this, '${tableId}')">${
              isCompleted ? "إلغاء الاكتمال" : "اكتمال"
            }</button>
                  <button class="btn btn-danger btn-sm delete-btn" onclick="deleteTask(this, '${tableId}')">حذف</button>
                  <button class="btn btn-danger btn-sm important-btn" onclick="showColorPicker(this, '${tableId}')">${
              isImportant ? "إلغاء الأهمية" : "تحديد اللون"
            }</button>
                  <button class="btn btn-secondary btn-sm remove-color-btn" onclick="removeColor(this, '${tableId}')">إزالة اللون</button>
                </div>
              </td>
            `;

            const startIndex = tableId === "mainTable1" ? 1 : 0;
            const dataCells = Array.from(row.querySelectorAll("td")).slice(
              startIndex,
              -1
            );
            if (isImportant && importantColor) {
              dataCells.forEach((cell) => cell.classList.add(importantColor));
            }
          });
          sortTableByStartTime(tableId);
        } else {
          const defaultTasks = [
            {
              siteStartTime: "06:00",
              type: "",
              location: "",
              required: "",
            },
            {
              siteStartTime: "03:30",
              type: "",
              location: "",
              required: "",
            },
            {
              siteStartTime: "13:30",
              type: "",
              location: "",
              required: "",
            },
            {
              siteStartTime: "14:00",
              type: "",
              location: "",
              required: "",
            },
          ];
          defaultTasks.forEach((task, index) => {
            const dateText = `${weekDay} ${hijriDay} ${
              hijriMonths[hijriMonth - 1]
            }، ${hijriYear} هـ`;
            const row = table.insertRow();
            row.innerHTML = `
              ${tableId === "mainTable1" ? `<td>${index + 1}</td>` : ""}
              <td class="date-cell">
                <select class="hijri-select" name="week-day">
                  ${weekDays
                    .map(
                      (day) =>
                        `<option value="${day}" ${
                          day === weekDay ? "selected" : ""
                        }>${day}</option>`
                    )
                    .join("")}
                </select>
                <select class="hijri-select" name="hijri-day">
                  ${Array.from({ length: 30 }, (_, i) => i + 1)
                    .map(
                      (day) =>
                        `<option value="${day}" ${
                          day === hijriDay ? "selected" : ""
                        }>${day}</option>`
                    )
                    .join("")}
                </select>
                <select class="hijri-select" name="hijri-month">
                  ${hijriMonths
                    .map(
                      (m, i) =>
                        `<option value="${i + 1}" ${
                          i + 1 === hijriMonth ? "selected" : ""
                        }>${m}</option>`
                    )
                    .join("")}
                </select>
                <select class="hijri-select" name="hijri-year">
                  ${Array.from({ length: 41 }, (_, i) => 1430 + i)
                    .map(
                      (year) =>
                        `<option value="${year}" ${
                          year === hijriYear ? "selected" : ""
                        }>${year}</option>`
                    )
                    .join("")}
                </select>
                <span class="print-date">${dateText}</span>
              </td>
              <td contenteditable="true">${task.siteStartTime}</td>
              <td contenteditable="true">${task.type}</td>
              <td contenteditable="true">${task.location}</td>
              <td contenteditable="true">${task.required}</td>
              <td class="edit-column">
                <div class="action-buttons">
                  <button class="btn btn-warning btn-sm edit-btn" onclick="editTable('${tableId}')">تعديل</button>
                  <button class="btn btn-success btn-sm complete-btn" onclick="toggleComplete(this, '${tableId}')">اكتمال</button>
                  <button class="btn btn-danger btn-sm delete-btn" onclick="deleteTask(this, '${tableId}')">حذف</button>
                  <button class="btn btn-danger btn-sm important-btn" onclick="showColorPicker(this, '${tableId}')">تحديد اللون</button>
                  <button class="btn btn-secondary btn-sm remove-color-btn" onclick="removeColor(this, '${tableId}')">إزالة اللون</button>
                </div>
              </td>
            `;
          });
          saveTableData(tableId);
          sortTableByStartTime(tableId);
        }
      }

      function updateAllTables() {
        ["mainTable1", "mainTable2"].forEach((tableId) => {
          const table = document
            .getElementById(tableId)
            .getElementsByTagName("tbody")[0];
          const rows = table.getElementsByTagName("tr");
          for (let row of rows) {
            const offset = tableId === "mainTable1" ? 1 : 0;
            const dateCell = row.cells[0 + offset];
            const dateText = `${weekDay} ${hijriDay} ${
              hijriMonths[hijriMonth - 1]
            }، ${hijriYear} هـ`;
            dateCell.innerHTML = `
              <select class="hijri-select" name="week-day">
                ${weekDays
                  .map(
                    (day) =>
                      `<option value="${day}" ${
                        day === weekDay ? "selected" : ""
                      }>${day}</option>`
                  )
                  .join("")}
              </select>
              <select class="hijri-select" name="hijri-day">
                ${Array.from({ length: 30 }, (_, i) => i + 1)
                  .map(
                    (day) =>
                      `<option value="${day}" ${
                        day === hijriDay ? "selected" : ""
                      }>${day}</option>`
                  )
                  .join("")}
              </select>
              <select class="hijri-select" name="hijri-month">
                ${hijriMonths
                  .map(
                    (m, i) =>
                      `<option value="${i + 1}" ${
                        i + 1 === hijriMonth ? "selected" : ""
                      }>${m}</option>`
                  )
                  .join("")}
              </select>
              <select class="hijri-select" name="hijri-year">
                ${Array.from({ length: 41 }, (_, i) => 1430 + i)
                  .map(
                    (year) =>
                      `<option value="${year}" ${
                        year === hijriYear ? "selected" : ""
                      }>${year}</option>`
                  )
                  .join("")}
              </select>
              <span class="print-date">${dateText}</span>
            `;
          }
        });
      }

      function updatePendingTasks() {
        const pendingTasks = [];
        ["mainTable1", "mainTable2"].forEach((tableId) => {
          const tableData = JSON.parse(
            localStorage.getItem(tableId + "_tasks") || "[]"
          );
          tableData.forEach((task) => {
            if (!task[5]) {
              pendingTasks.push(task);
            }
          });
        });
        localStorage.setItem("pending_tasks", JSON.stringify(pendingTasks));
      }

      function printTable(tableId) {
        window.print();
      }

      function editText(elementId) {
        const element = document.getElementById(elementId);
        const currentValue = element.innerHTML;
        element.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentValue}">`;
        const button = element.nextElementSibling;
        button.innerText = "حفظ";
        button.className = "btn btn-success btn-sm edit-btn";
        button.onclick = function () {
          saveText(elementId);
        };
      }

      function saveText(elementId) {
        const element = document.getElementById(elementId);
        const input = element.getElementsByTagName("input")[0];
        element.innerHTML = input.value;
        const button = element.nextElementSibling;
        button.innerText = "تعديل";
        button.className = "btn btn-warning btn-sm edit-btn";
        button.onclick = function () {
          editText(elementId);
        };
        localStorage.setItem(elementId, input.value);
      }

      document.addEventListener("DOMContentLoaded", function () {
        populateDateSelects();
        loadTableData("mainTable1");
        loadTableData("mainTable2");
        updateHeaderDate();
        updatePendingTasks();
      });
    </script>
  </body>
</html>
