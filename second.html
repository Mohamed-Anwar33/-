<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>الجدول الثالث</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        font-family: "Tajawal", sans-serif;
        background-color: #f0f4f8;
        direction: rtl;
        margin: 0;
        padding: 0;
      }
      .container {
        padding: 15px;
        max-width: 1200px;
        margin: 0 auto;
        text-align: right;
      }
      h2,
      h3,
      h4 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 8px;
      }
      .small-text {
        font-size: 12px;
        text-align: center;
      }
      .table-section {
        margin-bottom: 10px;
      }
      .table {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
      }
      .table-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }
      .table th,
      .table td {
        text-align: center;
        vertical-align: middle;
        padding: 6px;
      }
      .table td {
        font-size: 10px;
        font-weight: bold;
      }
      .table th:nth-child(1),
      .table td:nth-child(1) {
        width: 5%;
      }
      .table th:nth-child(2),
      .table td:nth-child(2) {
        width: 15%;
      }
      .table th:nth-child(3),
      .table td:nth-child(3) {
        width: 10%;
      }
      .table th:nth-child(4),
      .table td:nth-child(4) {
        width: 25%;
      }
      .table th:nth-child(5),
      .table td:nth-child(5) {
        width: 15%;
      }
      .table th:nth-child(6),
      .table td:nth-child(6) {
        width: 25%;
      }
      .table th:nth-child(7),
      .table td:nth-child(7) {
        width: 5%;
      }
      .hijri-select {
        width: 45px !important;
        font-size: 9px;
        padding: 2px;
      }
      .action-buttons {
        display: flex;
        justify-content: center;
        gap: 5px;
        flex-wrap: wrap;
      }
      .edit-btn,
      .complete-btn,
      .delete-btn,
      .important-btn,
      .remove-color-btn {
        margin: 2px;
        padding: 4px 8px;
        font-size: 12px;
        white-space: nowrap;
      }
      .important-task-dark-red {
        background-color: #ff9999 !important;
      }
      .important-task-dark-purple {
        background-color: #e6ccff !important;
      }
      .important-task-dark-green {
        background-color: #99cc99 !important;
      }
      .important-task-dark-blue {
        background-color: #99ccff !important;
      }
      .important-task-dark-brown {
        background-color: #d9b38c !important;
      }
      .important-task-deep-red {
        background-color: #e57373 !important;
      }
      .important-task-deep-blue {
        background-color: #64b5f6 !important;
      }
      .important-task-deep-green {
        background-color: #81c784 !important;
      }
      .important-task-deep-orange {
        background-color: #ffb74d !important;
      }
      .important-task-deep-purple {
        background-color: #ba68c8 !important;
      }
      .color-picker {
        margin-top: 5px;
      }
      .color-select {
        width: 120px;
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #ced4da;
        font-size: 12px;
        transition: all 0.3s ease;
      }
      .color-select:focus {
        outline: none;
        border-color: #2c3e50;
        box-shadow: 0 0 5px rgba(44, 62, 80, 0.3);
      }
      .color-select option {
        padding: 5px;
      }
      .notes {
        text-align: right;
      }
      .notes ul,
      .notes p {
        font-size: 11px;
      }
      .signature-section {
        text-align: left;
        width: 100%;
      }
      .signature-section p {
        display: block;
        text-align: left;
        margin-left: 0;
        margin-right: auto;
      }
      .time-input,
      .hijri-select,
      .color-select {
        margin: 0 2px;
        display: inline-block;
      }
      .date-controls {
        display: flex;
        gap: 5px;
        justify-content: center;
      }
      .print-date {
        display: none;
      }
      .section {
        margin-top: 20px;
        text-align: center;
      }
      .section p {
        margin: 5px 0;
        font-size: 12px;
      }
      .title {
        font-weight: bold;
        text-decoration: underline;
        font-size: 14px;
        margin-bottom: 10px;
      }
      .greeting {
        font-size: 14px;
        margin: 20px 0;
        text-align: right;
      }
      .subtitle {
        font-size: 16px;
        text-decoration: underline;
        text-align: center;
        margin: 20px 0;
      }
      @media print {
        @page {
          size: A4;
          margin: 10mm;
        }
        body {
          margin: 0;
          padding: 0;
          font-size: 8pt;
        }
        .container {
          padding: 5mm;
          margin: 0;
          max-width: 100%;
        }
        .date-controls,
        .table-buttons,
        .edit-column,
        button,
        .action-buttons,
        .navigation-buttons,
        a.btn {
          display: none !important;
        }
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        .hijri-select {
          display: none !important;
        }
        .print-date {
          display: inline !important;
          font-size: 8pt;
        }
        .table {
          margin-bottom: 5mm;
          font-size: 7pt;
        }
        .table th,
        .table td {
          padding: 2mm;
          height: 6mm;
          line-height: 1;
        }
        .table-section {
          margin-bottom: 2mm;
        }
        h4.header {
          font-size: 9pt;
          margin-bottom: 2mm;
        }
        .small-text {
          font-size: 7pt;
          margin-bottom: 1mm;
        }
        .introduction {
          font-size: 7pt;
          margin-top: 2mm;
          margin-bottom: 2mm;
        }
        .notes {
          margin-top: 2mm;
        }
        .notes h5 {
          font-size: 7pt;
          margin-bottom: 1mm;
        }
        .notes ul {
          font-size: 6pt;
          margin: 0;
          padding-right: 5mm;
          line-height: 1.2;
        }
        .signature-section p {
          font-size: 8pt;
          margin-top: 2mm;
          line-height: 1.2;
        }
        .important-task-dark-red {
          background-color: #ff9999 !important;
        }
        .important-task-dark-purple {
          background-color: #e6ccff !important;
        }
        .important-task-dark-green {
          background-color: #99cc99 !important;
        }
        .important-task-dark-blue {
          background-color: #99ccff !important;
        }
        .important-task-dark-brown {
          background-color: #d9b38c !important;
        }
        .important-task-deep-red {
          background-color: #e57373 !important;
        }
        .important-task-deep-blue {
          background-color: #64b5f6 !important;
        }
        .important-task-deep-green {
          background-color: #81c784 !important;
        }
        .important-task-deep-orange {
          background-color: #ffb74d !important;
        }
        .important-task-deep-purple {
          background-color: #ba68c8 !important;
        }
        .signature-section {
          text-align: left;
          width: 100%;
        }
        .signature-section p {
          text-align: left;
          margin-left: 0;
          margin-right: auto;
        }
        .greeting {
          font-size: 10pt;
          margin: 5mm 0;
        }
        .section {
          margin-top: 5mm;
          text-align: center;
        }
        .section p {
          font-size: 8pt;
          margin: 2mm 0;
        }
        .title {
          font-size: 10pt;
          margin-bottom: 3mm;
        }
        .subtitle {
          font-size: 12pt;
          margin: 5mm 0;
        }
      }
      @media (max-width: 430px) {
        .table {
          font-size: 7px;
          min-width: 600px;
        }
        .table-responsive {
          overflow-x: auto;
        }
        .edit-btn,
        .complete-btn,
        .delete-btn,
        .important-btn,
        .remove-color-btn {
          padding: 2px 4px;
          font-size: 9px;
          min-width: 50px;
        }
        .container {
          padding: 5px;
        }
        .action-buttons {
          flex-direction: column;
          gap: 2px;
          justify-content: center;
        }
        .hijri-select,
        .color-select {
          width: 35px !important;
          font-size: 7px;
        }
        .table th,
        .table td {
          padding: 3px;
        }
        .table td {
          white-space: normal;
          line-height: 1;
        }
        .greeting {
          font-size: 12px;
        }
        .section {
          text-align: center;
        }
        .section p {
          font-size: 10px;
        }
        .title {
          font-size: 12px;
        }
        .subtitle {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="section">
        <p class="title">تبليغ مباشرة مهمة</p>
        <p>قائد السريا - للمتابعة</p>
        <p>ضابط الميدان - للمتابعة</p>
        <p>ضابط خطر - للمتابعة</p>
        <p>رقيب السرية - فيما يخصكم</p>
        <p>رقيب فصل (ق) - فيما يخصكم</p>
        <p>رقيب مجموعة (٧) - فيما يخصكم</p>
        <p>رئيس العمليات</p>
        <p>رقيب الحركة والآليات</p>
      </div>

      <p class="greeting">السلام عليكم ورحمة الله وبركاته</p>

      <div class="section">
        <h2 class="subtitle">عن المهمة التالية</h2>
      </div>

      <div class="text-center mt-3">
        <h4 class="header fs-6 editable" id="title9">
          بيان بالمهام المكلفة بها قوة المهام والواجبات الخاصة ليوم
          <span id="selected-date"></span
          ><span id="print-selected-date" class="print-date"></span>
        </h4>
        <div class="date-controls mt-2">
          <select
            class="hijri-select"
            id="header-weekday"
            onchange="updateHeaderDate()"
          >
            <option value="السبت" selected>السبت</option>
            <option value="الأحد">الأحد</option>
            <option value="الإثنين">الإثنين</option>
            <option value="الثلاثاء">الثلاثاء</option>
            <option value="الأربعاء">الأربعاء</option>
            <option value="الخميس">الخميس</option>
            <option value="الجمعة">الجمعة</option>
          </select>
          <select
            class="hijri-select"
            id="header-day"
            onchange="updateHeaderDate()"
          ></select>
          <select
            class="hijri-select"
            id="header-month"
            onchange="updateHeaderDate()"
          ></select>
          <select
            class="hijri-select"
            id="header-year"
            onchange="updateHeaderDate()"
          ></select>
        </div>
      </div>

      <div class="table-responsive table-section">
        <table
          class="table table-bordered table-striped text-center align-middle"
          id="completedTable"
        >
          <thead class="table-dark">
            <tr>
              <th>التسلسل</th>
              <th>اليوم والتاريخ</th>
              <th>المباشرة بالموقع</th>
              <th>نوع المهمة</th>
              <th>الموقع</th>
              <th>المطلوب</th>
              <th class="edit-column">الحالة</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="table-buttons mt-3">
          <button
            class="btn btn-primary btn-sm print-btn"
            onclick="printTable('completedTable')"
          >
            طباعة
          </button>
        </div>
      </div>

      <div class="signature-section">
        <p
          id="signatureName"
          class="editable"
          style="
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            line-height: 1.8;
            text-align: left;
          "
        >
          <span style="display: block">قائد قوة المهام والواجبات الخاصة</span>
          <span style="display: block; margin-left: 175px">عقيد /</span>
          <span style="display: block; margin-left: 67px"
            >فيصل بن خالد النفيسة</span
          >
        </p>
      </div>

      <div class="text-center mt-4 navigation-buttons">
        <a href="index.html" class="btn btn-secondary btn-sm"
          >الجدول الأول والثاني</a
        >
        <a href="pending_tasks.html" class="btn btn-warning btn-sm"
          >المهام المؤجلة</a
        >
        <a href="feauturetsaks.html" class="btn btn-warning btn-sm"
          >المهام المستقبلية</a
        >
        <a href="statistics.html" class="btn btn-secondary btn-sm">الإحصائية</a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let hijriYear = 1444;
      let hijriMonth = 8;
      let hijriDay = 5;
      let weekDay = "السبت";

      const hijriMonths = [
        "محرم",
        "صفر",
        "ربيع أول",
        "ربيع ثاني",
        "جمادى أول",
        "جمادى ثاني",
        "رجب",
        "شعبان",
        "رمضان",
        "شوال",
        "ذو القعدة",
        "ذو الحجة",
      ];
      const weekDays = [
        "السبت",
        "الأحد",
        "الإثنين",
        "الثلاثاء",
        "الأربعاء",
        "الخميس",
        "الجمعة",
      ];
      const importantColors = [
        "important-task-dark-red",
        "important-task-dark-purple",
        "important-task-dark-green",
        "important-task-dark-blue",
        "important-task-dark-brown",
        "important-task-deep-red",
        "important-task-deep-blue",
        "important-task-deep-green",
        "important-task-deep-orange",
        "important-task-deep-purple",
      ];

      function populateDateSelects() {
        const daySelects = document.querySelectorAll(
          "select[name='hijri-day']"
        );
        daySelects.forEach((select) => {
          select.innerHTML = Array.from({ length: 30 }, (_, i) => i + 1)
            .map(
              (day) =>
                `<option value="${day}" ${
                  day === hijriDay ? "selected" : ""
                }>${day}</option>`
            )
            .join("");
        });
        const monthSelects = document.querySelectorAll(
          "select[name='hijri-month']"
        );
        monthSelects.forEach((select) => {
          select.innerHTML = hijriMonths
            .map(
              (m, i) =>
                `<option value="${i + 1}" ${
                  i + 1 === hijriMonth ? "selected" : ""
                }>${m}</option>`
            )
            .join("");
        });
        const yearSelects = document.querySelectorAll(
          "select[name='hijri-year']"
        );
        yearSelects.forEach((select) => {
          select.innerHTML = Array.from({ length: 41 }, (_, i) => 1430 + i)
            .map(
              (year) =>
                `<option value="${year}" ${
                  year === hijriYear ? "selected" : ""
                }>${year}</option>`
            )
            .join("");
        });
        const weekDaySelects = document.querySelectorAll(
          "select[name='week-day']"
        );
        weekDaySelects.forEach((select) => {
          select.innerHTML = weekDays
            .map(
              (day) =>
                `<option value="${day}" ${
                  day === weekDay ? "selected" : ""
                }>${day}</option>`
            )
            .join("");
        });
        const headerDaySelect = document.getElementById("header-day");
        headerDaySelect.innerHTML = Array.from({ length: 30 }, (_, i) => i + 1)
          .map(
            (day) =>
              `<option value="${day}" ${
                day === hijriDay ? "selected" : ""
              }>${day}</option>`
          )
          .join("");
        const headerMonthSelect = document.getElementById("header-month");
        headerMonthSelect.innerHTML = hijriMonths
          .map(
            (m, i) =>
              `<option value="${i + 1}" ${
                i + 1 === hijriMonth ? "selected" : ""
              }>${m}</option>`
          )
          .join("");
        const headerYearSelect = document.getElementById("header-year");
        headerYearSelect.innerHTML = Array.from(
          { length: 41 },
          (_, i) => 1430 + i
        )
          .map(
            (year) =>
              `<option value="${year}" ${
                year === hijriYear ? "selected" : ""
              }>${year}</option>`
          )
          .join("");
        const headerWeekDaySelect = document.getElementById("header-weekday");
        headerWeekDaySelect.innerHTML = weekDays
          .map(
            (day) =>
              `<option value="${day}" ${
                day === weekDay ? "selected" : ""
              }>${day}</option>`
          )
          .join("");
      }

      function updateHeaderDate() {
        weekDay = document.getElementById("header-weekday").value;
        hijriDay = parseInt(document.getElementById("header-day").value);
        hijriMonth = parseInt(document.getElementById("header-month").value);
        hijriYear = parseInt(document.getElementById("header-year").value);

        // حفظ القيم في localStorage
        localStorage.setItem("weekDay", weekDay);
        localStorage.setItem("hijriDay", hijriDay);
        localStorage.setItem("hijriMonth", hijriMonth);
        localStorage.setItem("hijriYear", hijriYear);

        const selectedDate = `${weekDay} ${hijriDay} ${
          hijriMonths[hijriMonth - 1]
        } ${hijriYear}`;
        const printDate = `اليوم: ${weekDay} ${hijriDay} ${
          hijriMonths[hijriMonth - 1]
        }، ${hijriYear} هـ`;
        document.getElementById("selected-date").innerText = selectedDate;
        document.getElementById("print-selected-date").innerText = printDate;
        updateAllTables();
      }

      function sortTableByStartTime(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const rows = Array.from(table.getElementsByTagName("tr"));
        rows.sort((a, b) => {
          const timeA = a.cells[2].innerText;
          const timeB = b.cells[2].innerText;
          return timeA.localeCompare(timeB);
        });
        table.innerHTML = "";
        rows.forEach((row, index) => {
          row.cells[0].innerText = index + 1;
          table.appendChild(row);
        });
      }

      function loadTableData(tableId) {
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const savedData = localStorage.getItem(tableId + "_tasks");
        console.log(`Loading data for ${tableId}:`, savedData);
        table.innerHTML = "";
        if (savedData) {
          const tasks = JSON.parse(savedData);
          tasks.forEach((rowData, index) => {
            const [weekDay, day, monthName, year] = rowData[0].split(" ");
            const month = hijriMonths.indexOf(monthName) + 1;
            const isCompleted = rowData[5];
            const isImportant = rowData[6] || false;
            const importantColor = rowData[7] || "";
            const dateText = `${weekDay} ${day} ${
              hijriMonths[month - 1]
            }، ${year} هـ`;
            const row = table.insertRow();
            row.innerHTML = `
              <td>${index + 1}</td>
              <td class="date-cell">
                <select class="hijri-select" name="week-day">${weekDays
                  .map(
                    (d) =>
                      `<option value="${d}" ${
                        d === weekDay ? "selected" : ""
                      }>${d}</option>`
                  )
                  .join("")}</select>
                <select class="hijri-select" name="hijri-day">${Array.from(
                  { length: 30 },
                  (_, i) => i + 1
                )
                  .map(
                    (d) =>
                      `<option value="${d}" ${
                        d === parseInt(day) ? "selected" : ""
                      }>${d}</option>`
                  )
                  .join("")}</select>
                <select class="hijri-select" name="hijri-month">${hijriMonths
                  .map(
                    (m, i) =>
                      `<option value="${i + 1}" ${
                        i + 1 === parseInt(month) ? "selected" : ""
                      }>${m}</option>`
                  )
                  .join("")}</select>
                <select class="hijri-select" name="hijri-year">${Array.from(
                  { length: 41 },
                  (_, i) => 1430 + i
                )
                  .map(
                    (y) =>
                      `<option value="${y}" ${
                        y === parseInt(year) ? "selected" : ""
                      }>${y}</option>`
                  )
                  .join("")}</select>
                <span class="print-date">${dateText}</span>
              </td>
              <td contenteditable="false">${rowData[1]}</td>
              <td contenteditable="false">${rowData[2]}</td>
              <td contenteditable="false">${rowData[3]}</td>
              <td contenteditable="false">${rowData[4]}</td>
              <td class="edit-column">${
                isCompleted ? "مكتمل" : "غير مكتمل"
              }</td>
            `;
            const dataCells = Array.from(row.querySelectorAll("td")).slice(
              1,
              -1
            );
            if (isImportant && importantColor)
              dataCells.forEach((cell) => cell.classList.add(importantColor));
          });
          sortTableByStartTime(tableId);
        }
      }

      function updateAllTables() {
        const tableId = "completedTable";
        const table = document
          .getElementById(tableId)
          .getElementsByTagName("tbody")[0];
        const rows = table.getElementsByTagName("tr");
        for (let row of rows) {
          const dateCell = row.cells[1];
          const dateText = `${weekDay} ${hijriDay} ${
            hijriMonths[hijriMonth - 1]
          }، ${hijriYear} هـ`;
          dateCell.innerHTML = `
            <select class="hijri-select" name="week-day">${weekDays
              .map(
                (day) =>
                  `<option value="${day}" ${
                    day === weekDay ? "selected" : ""
                  }>${day}</option>`
              )
              .join("")}</select>
            <select class="hijri-select" name="hijri-day">${Array.from(
              { length: 30 },
              (_, i) => i + 1
            )
              .map(
                (day) =>
                  `<option value="${day}" ${
                    day === hijriDay ? "selected" : ""
                  }>${day}</option>`
              )
              .join("")}</select>
            <select class="hijri-select" name="hijri-month">${hijriMonths
              .map(
                (m, i) =>
                  `<option value="${i + 1}" ${
                    i + 1 === hijriMonth ? "selected" : ""
                  }>${m}</option>`
              )
              .join("")}</select>
            <select class="hijri-select" name="hijri-year">${Array.from(
              { length: 41 },
              (_, i) => 1430 + i
            )
              .map(
                (year) =>
                  `<option value="${year}" ${
                    year === hijriYear ? "selected" : ""
                  }>${year}</option>`
              )
              .join("")}</select>
            <span class="print-date">${dateText}</span>
          `;
        }
      }

      function printTable(tableId) {
        window.print();
      }

      document.addEventListener("DOMContentLoaded", function () {
        // استعادة القيم من localStorage إذا كانت موجودة
        weekDay = localStorage.getItem("weekDay") || "السبت";
        hijriDay = parseInt(localStorage.getItem("hijriDay")) || 5;
        hijriMonth = parseInt(localStorage.getItem("hijriMonth")) || 8;
        hijriYear = parseInt(localStorage.getItem("hijriYear")) || 1444;

        populateDateSelects();
        loadTableData("completedTable");
        updateHeaderDate();
      });
    </script>
  </body>
</html>
